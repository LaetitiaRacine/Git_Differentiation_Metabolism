---
title: "scRNAseq_CITEseq_R_ReductionDimension"
author: "Laëtitia Racine"
date: "2022-10-03"
subtitle: "Last modification : `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: "hide"
    toc: true
    toc_float: false
    theme: journal
---

<style>
body {text-align: justify}
</style>

```{r, Setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

```

```{r, Dependencies}

library(Seurat)
library(dplyr)
library(ggplot2)
library(stringr)

```

https://satijalab.org/seurat/articles/pbmc3k_tutorial.html#perform-linear-dimensional-reduction-1
https://satijalab.org/seurat/articles/dim_reduction_vignette.html

```{r, Working directories and external script}

# Load working directories
directory = str_extract(string = getwd(), pattern = "[:graph:]+(?=bin)")
start_time = Sys.time()

# Create a unique folder for output corresponding to the date of the day
current_date = format(Sys.time(), "%Y%m%d")
dir.create(path = paste0(directory, "exp/scRNAseq_CITEseq_R_ReductionDimension/"))
dir.create(path = paste0(directory, "exp/scRNAseq_CITEseq_R_ReductionDimension/", current_date))
directory_output = paste0(directory, "exp/scRNAseq_CITEseq_R_ReductionDimension/", current_date, "/")

# Load external script with functions and constants
source(file = paste0(directory, "bin/", "functions_constants.R"))

```

```{r, Input loading}

dir = pic_last_dir(paste0(directory, "exp/", "scRNAseq_CITEseq_R_NormalizeData/"))

# Objects without cc regression
list_seurat = readRDS(paste0(dir, "/", "list_seurat_obj_qc_norm.rds"))
merged_all = merge(x = list_seurat[["CTRL"]], 
                   y = c(list_seurat[["CTRLaK"]], list_seurat[["DON"]], 
                         list_seurat[["DONaK"]], list_seurat[["2DG"]], 
                         list_seurat[["2DGaK"]], list_seurat[["VPA"]], 
                         list_seurat[["CTRL2"]], list_seurat[["AOA"]], 
                         list_seurat[["AOAaK"]]))
features_all = SelectIntegrationFeatures(object.list = list_seurat, nfeatures = 3000)
VariableFeatures(merged_all, assay = "SCT") = features_all
rm(list_seurat, features_all)

# Object with cc regression 
list_seurat_cc = readRDS(paste0(dir, "/", "list_seurat_obj_qc_norm_ccr.rds"))
features_all_cc = SelectIntegrationFeatures(object.list = list_seurat_cc, nfeatures = 3000)
merged_cc = merge(x = list_seurat_cc[["CTRL"]], 
                  y = c(list_seurat_cc[["CTRLaK"]], list_seurat_cc[["DON"]],
                        list_seurat_cc[["DONaK"]], list_seurat_cc[["2DG"]],
                        list_seurat_cc[["2DGaK"]], list_seurat_cc[["VPA"]],
                        list_seurat_cc[["CTRL2"]], list_seurat_cc[["AOA"]],
                        list_seurat_cc[["AOAaK"]]))
VariableFeatures(merged_cc, assay = "SCT") = features_all_cc
rm(list_seurat_cc, features_all_cc)

```

# Perform linear dimensional reduction and determine the "dimensionality" (PCA)

https://satijalab.org/seurat/articles/pbmc3k_tutorial.html#perform-linear-dimensional-reduction-1
Jackstraw method is time consuming for large dataset. We choose to use only the heuristic elbow plot method to determine the dimensionality.
On commence par tracer des "elbow plots" qui permettent de déterminer visuellement un nombre de dimensions à conserver (approximatif). Les dimensions sont rangées selon le pourcentage de variance qu'elles expliquent. On souhaite conserver les dimensions qui expliquent le plus la variance. Pour cela, on repère l'endroit où la courbe fait un coude.
De façon approximative, on observe que les 30 premières dimensions représentent la majorité de la variance donc on ne s'occupe plus des autres dimensions. 

```{r, PCA and dimensionality, fig.width = 20}

dim_choice_fun = function(obj, name_assay) {
  
  # Choose default assay
  DefaultAssay(obj) = name_assay

  # PCA calculation
  obj = RunPCA(object = obj,
               assay = name_assay,
               npcs = 100,
               reduction.name = "pca",
               seed.use = 42,
               verbose = TRUE)

  # Plots
  pca_plot = DimPlot(object = obj, 
                     group.by = "orig.ident", 
                     reduction = "pca") + NoLegend() 
  
  pca_split_plot = DimPlot(object = obj, 
                           group.by = "orig.ident", 
                           split.by = "orig.ident", 
                           reduction = "pca")
   
  elb_plot = ElbowPlot(object = obj, ndims = 100, reduction = "pca") +
    geom_vline(xintercept = 10, color = "red", size = 1) +
    geom_vline(xintercept = 20, color = "red", size = 1) +
    geom_vline(xintercept = 30, color = "red", size = 1) +
    geom_vline(xintercept = 40, color = "red", size = 1) +
    theme(plot.background = element_rect(fill = "white"))

  pca_dim = VizDimLoadings(object = obj,
                           dims = 1:30, 
                           reduction = "pca")

  # Outputs
  results = list(obj = obj,
                 pca_plot = pca_plot,
                 pca_split_plot = pca_split_plot,
                 elb_plot = elb_plot,
                 pca_dim = pca_dim)
  return(results)
  
}

dim_seurat_obj = dim_choice_fun(merged_all, "SCT")
merged_all = dim_seurat_obj$obj

dim_seurat_obj_cc = dim_choice_fun(merged_cc, "SCT")
merged_cc = dim_seurat_obj_cc$obj

```

```{r, PCA plot1, fig.width = 20, fig.height=24}

(dim_seurat_obj$elb_plot | dim_seurat_obj$pca_plot) / dim_seurat_obj$pca_split_plot
dim_seurat_obj$pca_dim

```

```{r, PCA plot2, fig.height = 20, fig.width = 24}

(dim_seurat_obj_cc$elb_plot | dim_seurat_obj_cc$pca_plot) / dim_seurat_obj_cc$pca_split_plot
dim_seurat_obj_cc$pca_dim

```

```{r, Dimension choice}

print("We chose dimensions 1 --> 40 for downstream analysis.")
dim_choice = c(1:40)

```


# Perform non-linear dimensional reduction (UMAP)

```{r, UMAP}

umap_fun = function(obj, assay_name, dim_choice) {
  
  obj = RunUMAP(object = obj, 
                assay = name_assay,
                dims = dim_choice, 
                reduction =  "pca", 
                reduction.name = "umap",
                set.seed = 42,
                verbose = TRUE)

  umap_plot = DimPlot(object = obj, 
                      group.by = "orig.ident", 
                      reduction = "umap",
                      cols = color_code) 
  
  umap_split_plot = DimPlot(object = obj, 
                            group.by = "orig.ident", 
                            split.by = "orig.ident", 
                            reduction = "umap",
                            cols = color_code) + NoLegend()
  
  results = list(obj = obj,
                 umap_plot = umap_plot,
                 umap_split_plot = umap_split_plot)
  
  return(results)
  
}

umap_seurat_obj = umap_fun(merged_all, "SCT", dim_choice)
merged_all = umap_seurat_obj$obj

umap_seurat_obj_cc = umap_fun(merged_cc, "SCT", dim_choice)
merged_cc = umap_seurat_obj_cc$obj

```

```{r, UMAP plot without cc, fig.width = 12}

umap_seurat_obj$umap_plot / umap_seurat_obj$umap_split_plot

```

```{r, UMAP plot with cc, fig.width = 22}

umap_seurat_obj_cc$umap_plot / umap_seurat_obj_cc$umap_split_plot

```

Not the same graph as in BatchEffectCorrection script because we didn't choose the same dimensions.
If we change the dimensions in 1:30, we obtain the same graph.
For latter downstream analysis, we choose to use the merge object without cc and the SCT normalisation with 1-40 dimensions.

```{r, Save outputs}

# Without cc regression
ggsave(plot = (dim_seurat_obj$elb_plot | dim_seurat_obj$pca_plot) / dim_seurat_obj$pca_split_plot, 
       filename = paste0(directory_output, "dimension_choice_elb_pca.svg"),
       height = 12, width = 20)
ggsave(plot = dim_seurat_obj$pca_dim, 
       filename = paste0(directory_output, "dimension_choice_pca_genes.svg"),
       height = 26, width = 20)
ggsave(plot = umap_seurat_obj$umap_plot,
       filename = paste0(directory_output, "umap_1-40dim.svg"),
       height = 8, width = 12)
ggsave(plot = umap_seurat_obj$umap_split_plot,
       filename = paste0(directory_output, "umap_1-40dim_split.svg"),
       height = 7, width = 28)

saveRDS(merged_all, paste0(directory_output, "merged_all_1-40dim.rds"))


# With cc regression
ggsave(plot = (dim_seurat_obj_cc$elb_plot | dim_seurat_obj_cc$pca_plot) / dim_seurat_obj_cc$pca_split_plot, 
       filename = paste0(directory_output, "dimension_choice_elb_pca_cc.svg"),
       height = 12, width = 20)
ggsave(plot = dim_seurat_obj_cc$pca_dim, 
       filename = paste0(directory_output, "dimension_choice_pca_genes_cc.svg"),
       height = 26, width = 20)
ggsave(plot = umap_seurat_obj_cc$umap_plot,
       filename = paste0(directory_output, "umap_1-40dim_cc.svg"),
       height = 8, width = 12)
ggsave(plot = umap_seurat_obj_cc$umap_split_plot,
       filename = paste0(directory_output, "umap_1-40dim_split_cc.svg"),
       height = 7, width = 28)

saveRDS(merged_cc, paste0(directory_output, "merged_cc_1-40dim.rds")) 

```


```{r, Rsession}

end_time = Sys.time()
cat("Total execution time : ", as.numeric (end_time - start_time, units = "mins"), "minutes")

# Clean working space and memory 
rm(list = ls())
gc()

# Show package version
sessionInfo()

```
