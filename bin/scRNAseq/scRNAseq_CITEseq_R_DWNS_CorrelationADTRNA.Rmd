---
title: "scRNAseq_CITEseq_R_DWNS_CorrelationADTRNA"
author: "LaÃ«titia Racine"
date: "2022-10-03"
subtitle: "Last modification : `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: "hide"
    toc: true
    toc_float: false
    theme: journal
---

<style>
body {text-align: justify}
</style>

```{r, Setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

```

```{r, Dependencies}

library(Seurat)
library(dplyr)
library(ggplot2)
library(stringr)
library(gridExtra)
library(tidyr)
library(tidyverse)
library(scCustomize) # function Split_FeatureScatter
library(kableExtra)

```

```{r, Working directories and external script}

# Load working directories
directory = str_extract(string = getwd(), pattern = "[:graph:]+(?=bin)")
start_time = Sys.time()

# Create a unique folder for output corresponding to the date of the day
current_date = format(Sys.time(), "%Y%m%d")
dir.create(path = paste0(directory, "exp/scRNAseq_CITEseq_R_DWNS_CorrelationADTRNA/"))
dir.create(path = paste0(directory, "exp/scRNAseq_CITEseq_R_DWNS_CorrelationADTRNA/", current_date))
directory_output = paste0(directory, "exp/scRNAseq_CITEseq_R_DWNS_CorrelationADTRNA/", current_date, "/")

# Load external script with functions and constants
source(file = paste0(directory, "bin/", "functions_constants.R"))

```

```{r, Input loading}

dir = pic_last_dir(paste0(directory, "exp/", "scRNAseq_CITEseq_R_ReductionDimension/"))
merged_all = readRDS(file = paste0(dir, "/", "merged_all_1-40dim.rds"))

```

# Overview 

https://satijalab.org/seurat/articles/multimodal_vignette.html 



# Membrane protein vs RNA in each culture condition

```{r, UMAP ADT RNA}

col_scale = c("lightgrey","#CC00FFFF","#3300FFFF",
              "#0066FFFF", "#00FFFFFF", "#33FF00FF",
              "#FFFF00FF","#FF8800FF","#CC0000FF")

DefaultAssay(merged_all) = "ADT"
p1 = FeaturePlot(object = merged_all,
                 features = "cite_CD34.1",
                 cols = col_scale,
                 split.by = "orig.ident",
                 combine = FALSE)
p2 = FeaturePlot(object = merged_all,
                 features = "cite_CD133",
                 cols = col_scale,
                 split.by = "orig.ident",
                 combine = FALSE)

DefaultAssay(merged_all) = "SCT"
p3 = FeaturePlot(object = merged_all,
                 features = "sct_CD34",
                 cols = col_scale,
                 split.by = "orig.ident",
                 combine = FALSE)
p4 = FeaturePlot(object = merged_all,
                 features = "sct_PROM1",
                 cols = col_scale,
                 split.by = "orig.ident",
                 combine = FALSE)

```

**CD34 membrane protein detection and RNA expression in each condition.**

```{r, results='hold', fig.width=18, fig.height=8, fig.fullwidth=TRUE}

do.call("grid.arrange", c(p1, ncol=3))
do.call("grid.arrange", c(p3, ncol=3))

```

**CD133 membrane protein detection and RNA expression in each condition.**

```{r, results='hold', fig.width=18, fig.height=8, fig.fullwidth=TRUE}

do.call("grid.arrange", c(p2, ncol=3))
do.call("grid.arrange", c(p4, ncol=3))

```

**Scatter plot RNA CD34 vs CD133 (PROM1) and CD34 protein (CD34.1) vs CD133 protein.**

```{r, Scatter ADT RNA, results='hold', fig.width=18, fig.height=16, fig.fullwidth=TRUE}

# https://github.com/satijalab/seurat/issues/1080

Idents(merged_all) = "orig.ident"

DefaultAssay(merged_all) = "SCT"
sc1 = Split_FeatureScatter(merged_all,
                     feature1 = "CD34",
                     feature2 = "PROM1",
                     split.by = "orig.ident",
                     group.by = "orig.ident",
                     num_columns = 3) & NoLegend()

DefaultAssay(merged_all) = "ADT"
sc2 = Split_FeatureScatter(merged_all,
                     feature1 = "CD34.1",
                     feature2 = "CD133",
                     split.by = "orig.ident",
                     group.by = "orig.ident",
                     num_columns = 3) & NoLegend()

sc1/sc2

```



# Membrane protein groups in each culture condition

```{r}
DefaultAssay(merged_all) = "ADT"
```

<br>
We tried to depict the data on an histogram but the scale is too large to be able to see something. So we decided to use the *kmean algorithm* to define two groups of expression (high/low) of CD34 and CD133 proteins and study the distribution of the proteins in the cells between the conditions.
<br>

```{r, CD34 groups, fig.width=12, fig.height=8}

# Organize tab to calcul kmean
protein_tab_cd34 = as.data.frame(merged_all@assays$ADT@counts)["CD34.1",]
protein_tab_cd34 = tidyr::pivot_longer(data = protein_tab_cd34,
                                  cols = 1:ncol(protein_tab_cd34),
                                  names_to = "cell",
                                  values_to = "protein")
protein_tab_cd34 = protein_tab_cd34 %>% tibble::column_to_rownames(var="cell")

# Kmean calcul for two clusters
set.seed(42) # !!! important
fit = kmeans(protein_tab_cd34, 2)
protein_tab_cd34 = data.frame(protein_tab_cd34, fit$cluster)
table(protein_tab_cd34$fit.cluster)
# Limits of each cluster
lim_clust1 = c(min(protein_tab_cd34[protein_tab_cd34$fit.cluster==1,1]),
               max(protein_tab_cd34[protein_tab_cd34$fit.cluster==1,1]))
lim_clust2 = c(min(protein_tab_cd34[protein_tab_cd34$fit.cluster==2,1]),
               max(protein_tab_cd34[protein_tab_cd34$fit.cluster==2,1]))
# Ascending order
limits = sort(c(lim_clust1, lim_clust2))
# Threshold between the two clusters (use max of first cluster and min of second one)
var_kmean = mean(limits[2:3])
# Add the new groups into metadata of seurat object
cat("Limits cluster 1 :", lim_clust1, "=>high", "\n",
    "Limits cluster 2 :", lim_clust2, "=>low", "\n",
    "Kmean value = ", var_kmean)
# Add kmean information in the tab
protein_tab_cd34 = protein_tab_cd34 %>%
  dplyr::mutate(CD34_group = ifelse(fit.cluster==1, "CD34_high", "CD34_low")) %>%
  tibble::rownames_to_column(var = "cell") %>%
  dplyr::select(cell, CD34_group)

# Add the new groups into metadata of seurat object
meta_tab = as.data.frame(merged_all@meta.data) %>% rownames_to_column(var = "cell")
meta_tab = full_join(x = meta_tab, y = protein_tab_cd34, by = "cell")
meta_tab = meta_tab %>% column_to_rownames(var = "cell")
merged_all@meta.data = meta_tab

# Show the groups
DefaultAssay(merged_all) = "ADT"
p5 = DimPlot(object = merged_all,
             split.by = "orig.ident",
             group.by = "CD34_group",
             reduction = "umap",
             ncol = 3)
p5

table(merged_all$CD34_group)
table(merged_all$orig.ident, merged_all$CD34_group)

```

For CD133, the kmean with two groups is not very consistent because the *high group* contains a tiny number of cells. We decided to look for three groups with the kmean algorithm (high/medium/low). As we can see in the table, we only have 3 outliers in the *high* group. 

```{r, CD133 groups, fig.width=12, fig.height=8}

# Organize tab to calcul kmean
protein_tab_cd133 = as.data.frame(merged_all@assays$ADT@counts)["CD133",]
protein_tab_cd133 = tidyr::pivot_longer(data = protein_tab_cd133,
                                  cols = 1:ncol(protein_tab_cd133),
                                  names_to = "cell",
                                  values_to = "protein")
protein_tab_cd133 = protein_tab_cd133 %>% tibble::column_to_rownames(var="cell")

# Kmean calcul for two clusters
set.seed(42) # important !!!
fit = kmeans(protein_tab_cd133, 3)
protein_tab_cd133 = data.frame(protein_tab_cd133, fit$cluster)
table(protein_tab_cd133$fit.cluster)
# Limits of each cluster
lim_clust1 = c(min(protein_tab_cd133[protein_tab_cd133$fit.cluster==1,1]),
               max(protein_tab_cd133[protein_tab_cd133$fit.cluster==1,1]))
lim_clust2 = c(min(protein_tab_cd133[protein_tab_cd133$fit.cluster==2,1]),
               max(protein_tab_cd133[protein_tab_cd133$fit.cluster==2,1]))
lim_clust3 = c(min(protein_tab_cd133[protein_tab_cd133$fit.cluster==3,1]),
               max(protein_tab_cd133[protein_tab_cd133$fit.cluster==3,1]))
# Ascending order
limits = sort(c(lim_clust1, lim_clust2, lim_clust3))
# Threshold between the two clusters (use max of first cluster and min of second one)
var_kmean_1 = mean(limits[2:3])
var_kmean_2 = mean(limits[4:5])
cat("Limits cluster 1 :", lim_clust1, "=> low", "\n",
    "Limits cluster 2 :", lim_clust2, "=> medium", "\n",
    "Limits cluster 3 :", lim_clust3, "=> high", "\n",
    "Kmean value 1 = ", var_kmean_1, "\n",
    "Kmean value 2 = ", var_kmean_2)
# Add kmean information in the tab
protein_tab_cd133 = protein_tab_cd133 %>%
  dplyr::mutate(CD133_group = ifelse(fit.cluster == 1, "CD133_low",
                                     ifelse(fit.cluster == 2, "CD133_medium", "CD133_high")))  %>%
  tibble::rownames_to_column(var = "cell") %>%
  dplyr::select(cell, CD133_group)

# Add the new groups into metadata of seurat object
meta_tab = as.data.frame(merged_all@meta.data) %>% rownames_to_column(var = "cell")
meta_tab = full_join(x = meta_tab, y = protein_tab_cd133, by = "cell")
meta_tab = meta_tab %>% column_to_rownames(var = "cell")
merged_all@meta.data = meta_tab

# Show the groups
DefaultAssay(merged_all) = "ADT"
p6 = DimPlot(object = merged_all,
             split.by = "orig.ident",
             group.by = "CD133_group",
             reduction = "umap",
             ncol = 3)
p6

table(merged_all$CD133_group)
table(merged_all$orig.ident, merged_all$CD133_group)

```

To simplify the comparison with CD34, we merge *high* and *medium* groups into a *high-medium* group.

```{r, CD133 groups corrected, fig.width=12, fig.height=8}

protein_tab_cd133 = protein_tab_cd133 %>%
  dplyr::mutate(CD133_group_correct = ifelse(CD133_group == "CD133_low", "CD133_low", "CD133_high-medium"))

merged_all@meta.data$CD133_group_correct = protein_tab_cd133$CD133_group_correct

# Show the groups
DefaultAssay(merged_all) = "ADT"
p7 = DimPlot(object = merged_all,
             split.by = "orig.ident",
             group.by = "CD133_group_correct",
             reduction = "umap",
             ncol = 3)
p7

table(merged_all$CD133_group_correct)
table(merged_all$orig.ident, merged_all$CD133_group_correct)

```

**Results synthetize in tables.**

```{r, CD34 CD133 tab}

# Tab number
tab_34 = data.frame(table(merged_all@meta.data$CD34_group, 
                          merged_all@meta.data$orig.ident)) %>%
  tidyr::pivot_wider(names_from = Var2, values_from = Freq) %>%
  dplyr::rename("Surface_Protein" = "Var1")

tab_133 = data.frame(table(merged_all@meta.data$CD133_group, 
                           merged_all@meta.data$orig.ident)) %>%
  tidyr::pivot_wider(names_from = Var2, values_from = Freq) %>%
  dplyr::rename("Surface_Protein" = "Var1")

tab_raw_cond = rbind(tab_34, tab_133)

tab_raw_cond %>%
  kable(caption = "Raw cell distribution in conditions") %>%
  kable_styling()

# Tab number normalized
tot_nb_cells = tab_raw_cond[1,-1]+tab_raw_cond[2,-1]
tab_norm_cond = as.data.frame(round(mapply('/', tab_raw_cond[,-1] , tot_nb_cells)*1000))
tab_norm_cond$Surface_Protein = tab_raw_cond$Surface_Protein
tab_norm_cond = tab_norm_cond %>% dplyr::relocate(Surface_Protein, .before = "2DG")

tab_norm_cond %>%
  kable(caption = "Normalized cell distribution in conditions") %>%
  kable_styling()

# Tab percent 
tab_percent_cond = as.data.frame(mapply('/', tab_norm_cond[,-1], 10))
tab_percent_cond$Surface_Protein = tab_norm_cond$Surface_Protein
tab_percent_cond = tab_percent_cond %>% dplyr::relocate(Surface_Protein, .before = "2DG")
tab_percent_cond %>%
  kable(caption = "Percentage of cells with high/low surface protein for each condition.") %>%
  kable_styling()

```

We tried heatmaps but as downsampling is a mandatory step for those, it's not very good representation of all the cells from the condition.

```{r, CD34 and CD133 heatmaps, fig.height = 26, eval = FALSE}

# Random genes
conditions = unique(merged_all$orig.ident)
var_genes = merged_all@assays$SCT@var.features
random_genes = sample(var_genes, 200)

# CD34 heatmap
for (i in 1:length(conditions)) {

  obj = subset(merged_all, subset = orig.ident == conditions[i])
  plot = DoHeatmap(object = subset(obj, downsample = 1000), # Lost information but no choice here
          features = random_genes,
          group.by = "CD34_group",
          group.bar = TRUE,
          assay = "SCT",
          slot = "scale.data") +
    ggtitle(conditions[i])
  print(plot)
}

# CD133 heatmap
for (i in 1:length(conditions)) {

  obj = subset(merged_all, subset = orig.ident == conditions[i])
  plot = DoHeatmap(object = subset(obj, downsample = 1000), # Lost information but no choice here
          features = random_genes,
          group.by = "CD133_group",
          group.bar = TRUE,
          assay = "SCT",
          slot = "scale.data") +
    ggtitle(conditions[i])
  print(plot)
}

```


# Membrane protein groups repartition in clusters

For now, we do not look at the data in terms of conditions but in clusters.

```{r, ADT default}

DefaultAssay(merged_all) = "ADT"

```

```{r, UMAP, fig.width = 24, fig.height = 6}

umap_cluster = DimPlot(merged_all, 
                       label = TRUE, 
                       reduction = "umap", 
                       group.by = "clusters")

umap_cd34 = DimPlot(merged_all,
                    reduction = "umap", 
                    group.by = "CD34_group")

umap_cd133 = DimPlot(merged_all,
                     reduction = "umap", 
                     group.by = "CD133_group_correct")

umap_cluster|umap_cd34|umap_cd133

```

```{r, Vln, fig.width = 15, fig.height = 8}

vln_cd34 = VlnPlot(merged_all, features = "CD34.1",
                   pt.size = 0, group.by = "clusters") + 
  theme(legend.position = "top")

vln_cd133 = VlnPlot(merged_all, features = "CD133",
                    pt.size = 0, group.by = "clusters") + 
  theme(legend.position = "none")

vln_cd34/vln_cd133

```

```{r, tab}

tab_34 = data.frame(table(merged_all@meta.data$CD34_group, 
                          merged_all@meta.data$clusters)) %>%
  tidyr::pivot_wider(names_from = Var2, values_from = Freq) %>%
  dplyr::rename("Surface_Protein" = "Var1")

tab_133 = data.frame(table(merged_all@meta.data$CD133_group, 
                           merged_all@meta.data$clusters)) %>%
  tidyr::pivot_wider(names_from = Var2, values_from = Freq) %>%
  dplyr::rename("Surface_Protein" = "Var1")

tab_raw_clusters = rbind(tab_34, tab_133)

tab_raw_clusters %>%
  kable(caption = "Raw cell distribution in clusters") %>%
  kable_styling()

# Tab number normalized
tot_nb_cells = tab_raw_clusters[1,-1]+tab_raw_clusters[2,-1]
tab_norm_clusters = as.data.frame(round(mapply('/', tab_raw_clusters[,-1] , tot_nb_cells)*1000))
tab_norm_clusters$Surface_Protein = tab_raw_clusters$Surface_Protein
tab_norm_clusters = tab_norm_clusters %>% dplyr::relocate(Surface_Protein, .before = "0")

tab_norm_clusters %>%
  kable(caption = "Normalized cell distribution in clusters") %>%
  kable_styling()

# Tab percent
tab_percent_clusters = as.data.frame(mapply('/', tab_norm_clusters[,-1], 10))
tab_percent_clusters$Surface_Protein = tab_norm_clusters$Surface_Protein
tab_percent_clusters = tab_percent_clusters %>% dplyr::relocate(Surface_Protein, .before = "0")
tab_percent_clusters %>%
  kable(caption = "Percentage of cells with high/low surface protein for each cluster.") %>%
  kable_styling()

```


```{r, Save outputs, fig.show='hide'}

# save plots
ggsave(plot = do.call("grid.arrange", c(p1, ncol=3)),
       filename = paste0(directory_output, "umap_adt_cd34.svg"),
        width = 2, height = 16)
ggsave(plot = do.call("grid.arrange", c(p2, ncol=3)),
       filename = paste0(directory_output, "umap_adt_cd133.svg"),
       width = 22, height = 16)
ggsave(plot = do.call("grid.arrange", c(p3, ncol=3)),
       filename = paste0(directory_output, "umap_rna_cd34.svg"),
       width = 20, height = 16)
ggsave(plot = do.call("grid.arrange", c(p4, ncol=3)),
       filename = paste0(directory_output, "umap_rna_cd133.svg"),
       width = 20, height = 16)

ggsave(plot = p5, width = 20, height = 16,
       filename = paste0(directory_output, "umap_adt_cd34groups.svg"))
ggsave(plot = p6, width = 20, height = 16,
       filename = paste0(directory_output, "umap_adt_cd133groups.svg"))
ggsave(plot = p7, width = 20, height = 16,
       filename = paste0(directory_output, "umap_adt_cd133groups_correct.svg"))

ggsave(plot = sc1/sc2, width = 12, height = 16,
       filename = paste0(directory_output, "scatter_plot_adt.svg"))
ggsave(plot = umap_cluster|umap_cd34|umap_cd133, width = 24, height = 6,
       filename = paste0(directory_output, "umap_adt_clusters.svg"))
ggsave(plot = vln_cd34/vln_cd133, width = 12, height = 8,
       filename = paste0(directory_output, "vln_adt_clusters.svg"))

# save tables  
write.csv2(x = tab_raw_cond, row.names = FALSE,
           file = paste0(directory_output, "tab_raw_cond.csv"))
write.csv2(x = tab_norm_cond, row.names = FALSE,
           file = paste0(directory_output, "tab_norm_cond"))
write.csv2(x = tab_percent_cond, row.names = FALSE,
           file = paste0(directory_output, "tab_percent_cond"))
write.csv2(x = tab_raw_clusters, row.names = FALSE,
           file = paste0(directory_output, "tab_raw_clusters"))
write.csv2(x = tab_norm_clusters, row.names = FALSE,
           file = paste0(directory_output, "tab_norm_clusters"))
write.csv2(x = tab_percent_clusters, row.names = FALSE,
           file = paste0(directory_output, "tab_percent_clusters"))

```

```{r, Rsession}

end_time = Sys.time()
cat("Total execution time : ", as.numeric (end_time - start_time, units = "mins"), "minutes")

# Clean working space and memory
rm(list = ls())
gc()

# Show package version
sessionInfo()

```
